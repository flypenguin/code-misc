# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Kubernetes OAuth authentication testing playground that sets up a complete authentication stack using KIND (Kubernetes in Docker). The project creates a local test environment with Authelia (authentication server), Traefik (reverse proxy/ingress controller), and cert-manager for TLS certificates.

The architecture uses `localhost.traefik.me` domain (which resolves to 127.0.0.1) with Caddy as a reverse proxy to expose KIND cluster services on ports 8080 (HTTP) and 8443 (HTTPS).

## Essential Commands

### Cluster Management
- `make prepare` - Sets up KIND cluster, helm repos, and generates user files
- `make deploy` - Deploys all services (namespaces, helm charts, k8s objects)
- `make clean` - Removes generated deployment files and secrets
- `make prepare-cluster` - Creates KIND cluster named 'test-oauth'

### User Management
- `./create-users.py config-files/authelia-users.csv` - Generate Argon2 password hashes from CSV
- User data flows: CSV template → CSV file → YAML hashes → K8s secret

### Testing and Development
- `make ingress-test` - Tests ingress connectivity across multiple endpoints
- `make reverse-proxy` (or `make caddy`, `make lb`) - Starts Caddy reverse proxy
- `kind get clusters` - List existing KIND clusters
- `kubectl --context kind-test-oauth <command>` - Direct kubectl access

### Important Environment Requirements
- **Helm v3.18.4 or lower required** (configure with asdf)
- Docker vs Podman makes a difference for KIND behavior
- Python script uses `uv run --script` for dependency management

## Architecture Components

### Deployment Flow
1. **Preparation**: KIND cluster + helm repos + user generation
2. **Namespace creation**: Creates required namespaces (authelia, etc.)
3. **User secret generation**: CSV → Argon2 hashes → K8s secret
4. **Helm deployments**: Authelia, Traefik, cert-manager via values files
5. **K8s manifests**: Additional resources like ingress tests

### Key Configuration Files
- `helm-values-files/_deployment-infos.txt` - Maps service names to helm charts and namespaces
- `config-files/kind-cluster.yaml` - KIND cluster with port mappings (8080, 8443)
- `caddyfile` - Reverse proxy config for localhost.traefik.me
- `helm-values-files/values-*.yaml` - Helm chart configurations

### Network Architecture
```
Client → Caddy (80/443) → KIND cluster (8080/8443) → Traefik → Services
```
- External access: `http://foo.localhost.traefik.me` or `https://foo.localhost.traefik.me`
- Traefik dashboard: Available on traefik port (8090)
- TLS: cert-manager with internal CA for localhost.traefik.me domains

### User Authentication System
- **Authelia**: Main authentication provider with PostgreSQL backend
- **User storage**: File-based users database mounted from K8s secret
- **Password hashing**: Argon2id with configurable parameters
- **Session management**: Cookie-based with domain localhost.traefik.me

## File Organization Patterns

### Generated Files (cleaned by `make clean`)
- `helm-values-files/deploy-*.txt` - Helm deployment logs
- `k8s-objects/apply-*.txt` - Kubectl apply logs
- `config-files/authelia-password-hashes.yaml` - Generated from CSV
- `k8s-objects/k8s-authelia-users-secret.yaml` - Generated secret manifest

### Make Target Patterns
- `deploy-helm`: Processes all `values-*.yaml` files via `_deployment-infos.txt` mapping
- `deploy-k8s`: Applies all `k8s-*.yaml` manifests
- Auto-dependency tracking between user CSV → hashes → K8s secret

## Development Context

When working with this codebase:
- Use `kubectl --context kind-test-oauth` for cluster access
- Helm deployments use `--kube-context kind-test-oauth`
- Test connectivity with `make ingress-test` before troubleshooting
- User modifications require regenerating the entire user secret chain
- TLS certificates are auto-generated by cert-manager for localhost.traefik.me domains
